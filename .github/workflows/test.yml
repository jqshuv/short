name: ğŸ”© Test CI

on:
  push:
    branches: [ "main" ]
    tags-ignore:
      - 'v/*'
    paths-ignore:
      - 'docs/api-docs.yaml'
      - '.github/workflows/deploy.yml'
      - 'README.md'
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    name: ğŸ§ª Test short
    runs-on: ubuntu-latest
    steps:
    - name: â¬‡ï¸ Checkout
      uses: actions/checkout@v6
    - name: ğŸ“¦ Install bun
      uses: oven-sh/setup-bun@v2
    - name: ğŸ’½ Setup Enviroment
      run: |
        cp wrangler.example.toml wrangler.toml
        echo "[vars]" >> wrangler.toml
        echo "AUTH_SECRET = \"production_value\" " >> wrangler.toml
        echo "[[kv_namespaces]]" >> wrangler.toml
        echo "binding = \"SHORT_URLS\"" >> wrangler.toml
        echo "id = \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"" >> wrangler.toml
      env:
        KV_NAMESPACE_ID: ${{ secrets.CF_KV_ID }}
    - name: âš™ï¸ Install Dependencies
      run: bun install --frozen-lockfile
    - name: ğŸ§ª Run Tests
      run: bun run test

  docs:
    name: ğŸ§ª Build Documentation
    if: github.repository == 'jqshuv/short'
    runs-on: ubuntu-latest
    steps:
    - name: â¬‡ï¸ Checkout
      uses: actions/checkout@v6

    - name: ğŸ“¦ Install bun
      uses: oven-sh/setup-bun@v2
    - name: âš™ï¸ Install Dependencies
      run: bun install --frozen-lockfile
    - name: ğŸ“‹ Build Docs
      run: bun docs:build
